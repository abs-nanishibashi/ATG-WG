@page
@model GeneralAffairsManagementProject.Pages.NewOrderModel
@{
    ViewData["Title"] = "新規発注画面";
}

<h2>@ViewData["Title"]</h2>

<form method="post">
    <div class="form-group">
        <label>発注方法</label>
        <select asp-for="OrderingMethodId"
                id="orderingMethod"
                class="form-control">
            <option value="">選択してください</option>
            @foreach (var m in Model.OrderingMethods)
            {
                <option value="@m.Id">@m.Name</option>
            }
        </select>
        <span asp-validation-for="OrderingMethodId" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label>カテゴリ</label>
        <select asp-for="CategoryId"
                id="categorySelect"
                class="form-control"
                disabled>
            <option value="">選択してください</option>
        </select>
        <span asp-validation-for="CategoryId" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label>品目名</label>
        <select asp-for="ConsumablesId"
                id="itemSelect"
                class="form-control"
                disabled
                required>
            <option value="">選択してください</option>
        </select>
        <span asp-validation-for="ConsumablesId" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label>数量</label>
        <input asp-for="Quantity"
               type="number"
               class="form-control"
               min="1"
               max="99"
               required />
        <span asp-validation-for="Quantity" class="text-danger"></span>
    </div>

    <br />

    <button type="submit" class="btn btn-primary">
        追加
    </button>

    <button type="submit"
            class="btn btn-secondary"
            asp-page-handler="Cancel"
            formnovalidate>
        キャンセル
    </button>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const methodSelect = document.getElementById("orderingMethod");
        const categorySelect = document.getElementById("categorySelect");
        const itemSelect = document.getElementById("itemSelect");

        function resetSelect(select) {
            select.innerHTML = '<option value="">選択してください</option>';
            select.disabled = true;
        }

        methodSelect.addEventListener("change", async () => {
            resetSelect(categorySelect);
            resetSelect(itemSelect);

            if (!methodSelect.value) return;

            const res = await fetch(`?handler=Categories&methodId=${methodSelect.value}`);
            const list = await res.json();

            list.forEach(x => {
                const opt = document.createElement("option");
                opt.value = x.id;
                opt.textContent = x.name;
                categorySelect.appendChild(opt);
            });

            categorySelect.disabled = false;
        });

        categorySelect.addEventListener("change", async () => {
            resetSelect(itemSelect);

            if (!categorySelect.value) return;

            const res = await fetch(`?handler=Consumables&categoryId=${categorySelect.value}`);
            const list = await res.json();

            list.forEach(x => {
                const opt = document.createElement("option");
                opt.value = x.id;
                opt.textContent = x.name;
                itemSelect.appendChild(opt);
            });

            itemSelect.disabled = false;
        });

        // バリデーションエラーで戻った場合の復元
        window.addEventListener("load", () => {
            if (methodSelect.value) categorySelect.disabled = false;
            if (categorySelect.value) itemSelect.disabled = false;
        });
    </script>
}